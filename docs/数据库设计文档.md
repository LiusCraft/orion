# 数据库设计文档

## 文档信息
- **创建日期**: 2025-09-29
- **数据库类型**: PostgreSQL 14+ with pgvector
- **字符集**: UTF-8
- **时区**: UTC

## 1. 数据库架构概览

### 1.1 数据库选型
- **主数据库**: PostgreSQL 14+ - 事务支持、JSON字段、全文检索、向量存储
- **向量扩展**: pgvector - 向量相似度搜索
- **缓存数据库**: Redis - 会话缓存、热点数据

### 1.2 核心业务域
1. **用户管理**: 用户账号、权限、团队
2. **对话系统**: 会话、消息、上下文
3. **知识库**: 文档、分类、版本管理、向量存储
4. **工具系统**: 工具配置、调用记录
5. **系统管理**: 配置、日志、统计

## 2. 数据表设计

### 2.1 用户管理模块

#### users (用户表)
```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    display_name VARCHAR(100),
    avatar_url TEXT,
    role VARCHAR(20) NOT NULL DEFAULT 'user', -- admin, user, viewer
    department VARCHAR(50), -- 运维、研发、TS
    status VARCHAR(20) NOT NULL DEFAULT 'active', -- active, inactive, suspended
    last_login_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_status ON users(status);
```

#### user_sessions (用户会话表)
```sql
CREATE TABLE user_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    token_hash VARCHAR(255) NOT NULL,
    device_info JSONB, -- 设备信息
    ip_address INET,
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_user_sessions_user_id ON user_sessions(user_id);
CREATE INDEX idx_user_sessions_token_hash ON user_sessions(token_hash);
CREATE INDEX idx_user_sessions_expires_at ON user_sessions(expires_at);
```

### 2.2 对话系统模块

#### conversations (对话会话表)
```sql
CREATE TABLE conversations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    title VARCHAR(200), -- 会话标题，可为空
    context JSONB, -- 对话上下文信息
    status VARCHAR(20) NOT NULL DEFAULT 'active', -- active, archived, deleted
    total_messages INTEGER NOT NULL DEFAULT 0,
    last_message_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_conversations_user_id ON conversations(user_id);
CREATE INDEX idx_conversations_status ON conversations(status);
CREATE INDEX idx_conversations_last_message_at ON conversations(last_message_at);
```

#### messages (消息表)
```sql
CREATE TABLE messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    conversation_id UUID NOT NULL REFERENCES conversations(id) ON DELETE CASCADE,
    parent_message_id UUID REFERENCES messages(id), -- 支持消息树结构
    sender_type VARCHAR(10) NOT NULL, -- user, ai, system
    content TEXT NOT NULL,
    content_type VARCHAR(20) NOT NULL DEFAULT 'text', -- text, markdown, json
    metadata JSONB, -- 额外信息：工具调用结果、引用来源等
    token_count INTEGER, -- 消息token数量
    processing_time_ms INTEGER, -- AI处理时间
    status VARCHAR(20) NOT NULL DEFAULT 'completed', -- pending, completed, failed, streaming
    error_message TEXT, -- 错误信息
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_messages_conversation_id ON messages(conversation_id);
CREATE INDEX idx_messages_parent_id ON messages(parent_message_id);
CREATE INDEX idx_messages_sender_type ON messages(sender_type);
CREATE INDEX idx_messages_created_at ON messages(created_at);
```

#### message_attachments (消息附件表)
```sql
CREATE TABLE message_attachments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    message_id UUID NOT NULL REFERENCES messages(id) ON DELETE CASCADE,
    file_name VARCHAR(255) NOT NULL,
    file_path TEXT NOT NULL,
    file_size BIGINT NOT NULL,
    mime_type VARCHAR(100),
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_message_attachments_message_id ON message_attachments(message_id);
```

### 2.3 知识库模块

#### knowledge_categories (知识分类表)
```sql
CREATE TABLE knowledge_categories (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    parent_id UUID REFERENCES knowledge_categories(id),
    name VARCHAR(100) NOT NULL,
    description TEXT,
    sort_order INTEGER NOT NULL DEFAULT 0,
    status VARCHAR(20) NOT NULL DEFAULT 'active', -- active, inactive
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_knowledge_categories_parent_id ON knowledge_categories(parent_id);
CREATE INDEX idx_knowledge_categories_status ON knowledge_categories(status);
```

#### knowledge_documents (知识文档表)
```sql
CREATE TABLE knowledge_documents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    category_id UUID NOT NULL REFERENCES knowledge_categories(id),
    title VARCHAR(200) NOT NULL,
    content TEXT NOT NULL,
    content_type VARCHAR(20) NOT NULL DEFAULT 'markdown', -- markdown, html, text
    summary TEXT, -- 文档摘要
    tags TEXT[], -- 标签数组
    source_url TEXT, -- 原始链接
    author_id UUID REFERENCES users(id),
    version INTEGER NOT NULL DEFAULT 1,
    status VARCHAR(20) NOT NULL DEFAULT 'published', -- draft, published, archived
    view_count INTEGER NOT NULL DEFAULT 0,
    like_count INTEGER NOT NULL DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_knowledge_documents_category_id ON knowledge_documents(category_id);
CREATE INDEX idx_knowledge_documents_author_id ON knowledge_documents(author_id);
CREATE INDEX idx_knowledge_documents_status ON knowledge_documents(status);
CREATE INDEX idx_knowledge_documents_tags ON knowledge_documents USING GIN(tags);
-- 全文搜索索引
CREATE INDEX idx_knowledge_documents_search ON knowledge_documents USING GIN(to_tsvector('chinese', title || ' ' || content));
```

#### knowledge_document_versions (文档版本表)
```sql
CREATE TABLE knowledge_document_versions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    document_id UUID NOT NULL REFERENCES knowledge_documents(id) ON DELETE CASCADE,
    version INTEGER NOT NULL,
    title VARCHAR(200) NOT NULL,
    content TEXT NOT NULL,
    change_summary TEXT, -- 变更说明
    author_id UUID REFERENCES users(id),
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

-- 索引
CREATE UNIQUE INDEX idx_knowledge_document_versions_doc_version ON knowledge_document_versions(document_id, version);
```

#### knowledge_embeddings (知识向量表)
```sql
-- 需要先安装pgvector扩展
CREATE EXTENSION IF NOT EXISTS vector;

CREATE TABLE knowledge_embeddings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    document_id UUID NOT NULL REFERENCES knowledge_documents(id) ON DELETE CASCADE,
    chunk_index INTEGER NOT NULL, -- 文档片段索引
    chunk_content TEXT NOT NULL, -- 片段内容
    chunk_summary TEXT, -- 片段摘要
    embedding vector(1536), -- OpenAI text-embedding-ada-002的维度
    token_count INTEGER, -- 片段token数量
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_knowledge_embeddings_document_id ON knowledge_embeddings(document_id);
CREATE UNIQUE INDEX idx_knowledge_embeddings_doc_chunk ON knowledge_embeddings(document_id, chunk_index);
-- 向量相似度索引 (使用ivfflat算法)
CREATE INDEX idx_knowledge_embeddings_vector ON knowledge_embeddings USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100);
```

### 2.4 工具系统模块

#### tools (工具配置表)
```sql
CREATE TABLE tools (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) UNIQUE NOT NULL,
    display_name VARCHAR(100) NOT NULL,
    description TEXT,
    tool_type VARCHAR(50) NOT NULL, -- api, webhook, script
    config JSONB NOT NULL, -- 工具配置信息
    auth_config JSONB, -- 认证配置
    enabled BOOLEAN NOT NULL DEFAULT true,
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_tools_name ON tools(name);
CREATE INDEX idx_tools_type ON tools(tool_type);
CREATE INDEX idx_tools_enabled ON tools(enabled);
```

#### tool_executions (工具执行记录表)
```sql
CREATE TABLE tool_executions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tool_id UUID NOT NULL REFERENCES tools(id),
    message_id UUID REFERENCES messages(id), -- 关联的消息
    user_id UUID NOT NULL REFERENCES users(id),
    input_params JSONB NOT NULL, -- 输入参数
    output_result JSONB, -- 输出结果
    execution_time_ms INTEGER, -- 执行时间
    status VARCHAR(20) NOT NULL, -- pending, success, failed, timeout
    error_message TEXT,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_tool_executions_tool_id ON tool_executions(tool_id);
CREATE INDEX idx_tool_executions_message_id ON tool_executions(message_id);
CREATE INDEX idx_tool_executions_user_id ON tool_executions(user_id);
CREATE INDEX idx_tool_executions_status ON tool_executions(status);
CREATE INDEX idx_tool_executions_created_at ON tool_executions(created_at);
```

### 2.5 系统管理模块

#### system_configs (系统配置表)
```sql
CREATE TABLE system_configs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    config_key VARCHAR(100) UNIQUE NOT NULL,
    config_value JSONB NOT NULL,
    description TEXT,
    config_type VARCHAR(50) NOT NULL, -- llm, database, cache, etc.
    is_encrypted BOOLEAN NOT NULL DEFAULT false,
    updated_by UUID REFERENCES users(id),
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_system_configs_key ON system_configs(config_key);
CREATE INDEX idx_system_configs_type ON system_configs(config_type);
```

#### audit_logs (审计日志表)
```sql
CREATE TABLE audit_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    action VARCHAR(100) NOT NULL, -- create, update, delete, login, etc.
    resource_type VARCHAR(50) NOT NULL, -- user, document, tool, etc.
    resource_id UUID,
    old_values JSONB, -- 变更前的值
    new_values JSONB, -- 变更后的值
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_audit_logs_user_id ON audit_logs(user_id);
CREATE INDEX idx_audit_logs_action ON audit_logs(action);
CREATE INDEX idx_audit_logs_resource ON audit_logs(resource_type, resource_id);
CREATE INDEX idx_audit_logs_created_at ON audit_logs(created_at);
```

#### usage_statistics (使用统计表)
```sql
CREATE TABLE usage_statistics (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    date DATE NOT NULL,
    metric_type VARCHAR(50) NOT NULL, -- daily_active_users, message_count, etc.
    metric_value BIGINT NOT NULL,
    dimensions JSONB, -- 统计维度，如部门、用户类型等
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

-- 索引
CREATE UNIQUE INDEX idx_usage_statistics_date_type ON usage_statistics(date, metric_type);
CREATE INDEX idx_usage_statistics_type ON usage_statistics(metric_type);
```

## 3. 向量检索设计

### 3.1 向量相似度搜索
```sql
-- 查找相似知识片段
SELECT 
    ke.document_id,
    kd.title,
    ke.chunk_content,
    ke.chunk_summary,
    1 - (ke.embedding <=> $1::vector) as similarity
FROM knowledge_embeddings ke
JOIN knowledge_documents kd ON ke.document_id = kd.id
WHERE kd.status = 'published'
ORDER BY ke.embedding <=> $1::vector
LIMIT 10;
```

### 3.2 混合检索策略
```sql
-- 结合全文搜索和向量搜索
WITH text_search AS (
    SELECT document_id, ts_rank(search_vector, query) as text_score
    FROM knowledge_documents, to_tsquery('chinese', $1) query
    WHERE search_vector @@ query
),
vector_search AS (
    SELECT document_id, 1 - (embedding <=> $2::vector) as vector_score
    FROM knowledge_embeddings
    ORDER BY embedding <=> $2::vector
    LIMIT 20
)
SELECT 
    kd.*,
    COALESCE(ts.text_score, 0) * 0.3 + COALESCE(vs.vector_score, 0) * 0.7 as final_score
FROM knowledge_documents kd
LEFT JOIN text_search ts ON kd.id = ts.document_id
LEFT JOIN vector_search vs ON kd.id = vs.document_id
WHERE (ts.document_id IS NOT NULL OR vs.document_id IS NOT NULL)
ORDER BY final_score DESC
LIMIT 10;
```

## 4. 数据初始化脚本

### 4.1 扩展安装
```sql
-- 安装必要扩展
CREATE EXTENSION IF NOT EXISTS vector;
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS pg_trgm; -- 模糊搜索
CREATE EXTENSION IF NOT EXISTS zhparser; -- 中文分词
```

### 4.2 基础数据
```sql
-- 插入默认管理员用户
INSERT INTO users (username, email, password_hash, display_name, role, department, status) 
VALUES ('admin', 'admin@company.com', '$2b$12$...', '系统管理员', 'admin', '系统', 'active');

-- 插入默认知识分类
INSERT INTO knowledge_categories (name, description) VALUES 
('CDN基础', 'CDN基础概念和原理'),
('配置管理', 'CDN配置相关知识'),
('故障排查', '常见故障和解决方案'),
('性能优化', '性能优化最佳实践'),
('API文档', 'CDN平台API使用说明');

-- 插入系统配置
INSERT INTO system_configs (config_key, config_value, description, config_type) VALUES 
('llm.provider', '"openai"', 'LLM服务提供商', 'llm'),
('llm.model', '"gpt-4"', 'LLM模型名称', 'llm'),
('llm.temperature', '0.7', 'LLM温度参数', 'llm'),
('embedding.model', '"text-embedding-ada-002"', '嵌入模型', 'llm'),
('embedding.chunk_size', '1000', '文档分块大小', 'rag'),
('system.max_conversation_length', '50', '最大对话长度', 'system');
```

## 5. 性能优化策略

### 5.1 向量索引优化
```sql
-- 调整ivfflat索引参数
SET ivfflat.probes = 10; -- 查询时探测的列表数量

-- 对于大量数据，可以考虑使用hnsw索引（PostgreSQL 16+）
CREATE INDEX idx_knowledge_embeddings_vector_hnsw 
ON knowledge_embeddings USING hnsw (embedding vector_cosine_ops) 
WITH (m = 16, ef_construction = 64);
```

### 5.2 查询优化
```sql
-- 创建复合索引优化常用查询
CREATE INDEX idx_conversations_user_status ON conversations(user_id, status);
CREATE INDEX idx_messages_conv_created ON messages(conversation_id, created_at);
```

### 5.3 分区策略
```sql
-- 按时间分区大表
CREATE TABLE audit_logs_2025_01 PARTITION OF audit_logs
FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

CREATE TABLE tool_executions_2025_01 PARTITION OF tool_executions
FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');
```

## 6. 缓存策略

### 6.1 Redis缓存设计
```
# 用户会话缓存
session:{token_hash} -> {user_info}

# 热点文档缓存
document:{document_id} -> {document_content}

# 系统配置缓存
config:{config_key} -> {config_value}

# 对话上下文缓存
conversation:{conversation_id} -> {context_data}
```

## 7. 备份与安全

### 7.1 数据备份
```bash
# 每日备份脚本
pg_dump -h localhost -U postgres -d cdnagent --clean --if-exists --create > backup_$(date +%Y%m%d).sql

# WAL备份
archive_command = 'cp %p /backup/wal/%f'
```

### 7.2 安全措施
- 行级安全策略 (RLS)
- 敏感字段加密
- 连接SSL加密
- 定期安全审计

---

**文档版本**: v1.0  
**最后更新**: 2025-09-29  
**维护人**: 后端团队